<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buku Tamu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl mx-auto">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Buku Tamu Sederhana</h1>
        <p class="text-center text-gray-600 mb-8">Tambahkan nama dan pesan Anda di bawah ini.</p>

        <!-- Formulir untuk menambahkan pesan -->
        <form id="guestbook-form" class="space-y-4">
            <div>
                <label for="name" class="block text-sm font-medium text-gray-700">Nama</label>
                <input type="text" id="name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="message" class="block text-sm font-medium text-gray-700">Pesan</label>
                <textarea id="message" rows="4" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>
            <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                Kirim Pesan
            </button>
        </form>

        <hr class="my-8 border-gray-200">
        
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Pesan-Pesan</h2>

        <!-- Area untuk menampilkan pesan dari database -->
        <div id="messages-container" class="space-y-4">
            <p id="status-message" class="text-center text-gray-500">Memuat pesan...</p>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Variabel global Firebase (disediakan oleh lingkungan)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId;
        const statusMessage = document.getElementById('status-message');
        const messagesContainer = document.getElementById('messages-container');
        const form = document.getElementById('guestbook-form');
        const submitButton = form.querySelector('button[type="submit"]');

        // Fungsi untuk menginisialisasi Firebase
        function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                console.log("Firebase services initialized.");

                // Dengarkan perubahan status otentikasi
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authentication successful. User ID:", userId);
                        // Mulai mendengarkan pesan hanya setelah otentikasi berhasil
                        startMessageListener();
                    } else {
                        console.log("Signing in...");
                        // Jika tidak ada pengguna, coba login
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Error signing in:", error);
                            statusMessage.textContent = "Gagal terhubung. Silakan periksa koneksi internet.";
                        }
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                statusMessage.textContent = "Gagal memuat aplikasi. Pastikan konfigurasi Firebase benar.";
            }
        }

        // Fungsi untuk mendengarkan pembaruan real-time dari Firestore
        function startMessageListener() {
            if (!db) {
                console.error("Firestore database is not initialized.");
                statusMessage.textContent = "Database tidak terhubung.";
                return;
            }

            const messagesCollection = collection(db, `/artifacts/${appId}/public/data/guestbook_messages`);
            const q = query(messagesCollection, orderBy('timestamp', 'desc'));

            onSnapshot(q, (snapshot) => {
                const messages = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    messages.push({ id: doc.id, ...data });
                });
                
                displayMessages(messages);
            }, (error) => {
                console.error("Error fetching messages in real-time:", error);
                statusMessage.textContent = "Gagal memuat pesan. Silakan coba lagi nanti.";
            });
        }
        
        // Fungsi untuk menampilkan pesan di halaman
        function displayMessages(messages) {
            messagesContainer.innerHTML = ''; // Hapus pesan sebelumnya
            statusMessage.style.display = 'none';

            if (messages.length === 0) {
                messagesContainer.innerHTML = '<p class="text-center text-gray-500">Belum ada pesan. Jadilah yang pertama!</p>';
                return;
            }

            messages.forEach(msg => {
                const messageCard = document.createElement('div');
                messageCard.className = 'bg-gray-100 p-4 rounded-lg shadow-sm';
                
                const nameText = document.createElement('h3');
                nameText.className = 'font-semibold text-gray-900';
                nameText.textContent = msg.name;
                
                const messageText = document.createElement('p');
                messageText.className = 'text-gray-700 mt-1';
                messageText.textContent = msg.message;

                const timestampText = document.createElement('p');
                timestampText.className = 'text-xs text-gray-500 mt-2';
                const date = msg.timestamp ? new Date(msg.timestamp.toDate()) : new Date();
                timestampText.textContent = date.toLocaleString('id-ID', {
                    year: 'numeric', month: 'long', day: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });

                messageCard.appendChild(nameText);
                messageCard.appendChild(messageText);
                messageCard.appendChild(timestampText);
                
                messagesContainer.appendChild(messageCard);
            });
        }

        // Tangani pengiriman formulir
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!db || !userId) {
                console.error("Firestore or user is not initialized. Cannot submit message.");
                statusMessage.textContent = "Tidak dapat mengirim pesan. Mohon tunggu hingga terhubung.";
                return;
            }

            const name = document.getElementById('name').value;
            const message = document.getElementById('message').value;

            submitButton.disabled = true;
            submitButton.textContent = 'Mengirim...';

            try {
                await addDoc(collection(db, `/artifacts/${appId}/public/data/guestbook_messages`), {
                    name: name,
                    message: message,
                    timestamp: serverTimestamp(),
                    userId: userId 
                });
                
                // Bersihkan kolom formulir setelah berhasil dikirim
                form.reset();
            } catch (error) {
                console.error("Error adding document:", error);
                statusMessage.textContent = "Gagal mengirim pesan. Silakan coba lagi.";
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Kirim Pesan';
            }
        });
        
        // Inisialisasi aplikasi saat halaman dimuat
        initializeFirebase();

    </script>
</body>
</html>
